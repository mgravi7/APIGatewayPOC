# APIGatewayPOC - Copilot Instructions

## Project Overview
This is a proof-of-concept microservices application demonstrating API Gateway patterns using Envoy as the gateway, Keycloak for authentication, and FastAPI for microservices.

## Architecture
- **API Gateway**: Envoy proxy handling routing, load balancing, and JWT validation
- **Authentication**: Keycloak providing OAuth 2.0 / OpenID Connect
- **Customer Service**: FastAPI microservice for customer management
- **Product Service**: FastAPI microservice for product management
- **Containerization**: Docker & Docker Compose for orchestration

## Documentation Structure

**NEW**: Documentation has been reorganized for better navigation:

```
docs/
??? setup/           # Installation and setup guides
??? security/        # Security documentation
??? development/     # Developer guides and quick reference
??? architecture/    # Architecture documentation (future)
??? api/ # API reference (future)
??? operations/      # Deployment guides (future)

reports/       # Project status and verification reports
scripts/       # Utility scripts with their own README
```

**Key Documentation Files:**
- `README.md` - Main project overview (root)
- `QUICK_START.md` - 5-minute getting started (root)
- `docs/README.md` - Documentation index
- `docs/setup/keycloak-setup.md` - Keycloak configuration
- `docs/security/security-guide.md` - Comprehensive security docs
- `docs/security/quick-reference.md` - Security quick reference
- `docs/development/quick-reference.md` - Common commands
- `reports/project-status.md` - Current project status
- `scripts/README.md` - Scripts documentation

## Development Guidelines

### Code Style & Standards
- Use Python 3.11+ with FastAPI framework
- Follow PEP 8 style guidelines
- Use Pydantic models for data validation
- Include comprehensive docstrings for all functions
- Use type hints throughout the codebase

### API Design Principles
- RESTful API design patterns
- Consistent error handling and HTTP status codes
- Health check endpoints on all services (`/[service]/health`)
- Proper request/response models with Pydantic
- Version APIs appropriately

### Security Guidelines
- **NEVER** commit secrets to git
- Use environment variables for all configuration
- Follow security best practices in `docs/security/security-guide.md`
- Client secrets required for all confidential clients
- JWT validation enforced at API Gateway level
- Restricted redirect URIs (no wildcards in production)

### Docker & Deployment
- Use multi-stage Docker builds where appropriate
- Keep Docker images minimal and secure
- Use non-root users in containers
- Implement proper environment variable handling
- Include health checks in Docker containers

### Testing Strategy
- Unit tests for business logic
- Integration tests for API endpoints
- End-to-end tests through the API Gateway
- Use pytest framework
- Mock external dependencies appropriately

### Project Structure
```
services/
 gateway/       # Envoy API Gateway configuration
    keycloak/      # Keycloak IAM configuration
    customer-service/ # Customer management microservice
    product-service/  # Product management microservice
    shared/           # Shared utilities and common code

docs/               # All documentation
    setup/       # Setup guides
    security/         # Security documentation
    development/# Developer guides

reports/ # Status and verification reports
scripts/              # Utility scripts
tests/ # Integration and unit tests
```

### Environment Setup
1. Ensure Docker Desktop is installed and running
2. Copy `.env.example` to `.env` and configure
3. Use `docker-compose up --build` to start all services
4. API Gateway accessible at `http://localhost:8080`
5. Keycloak admin at `http://localhost:8180`
6. Envoy admin interface at `http://localhost:9901`

### Development Workflow
1. Make changes to service code
2. Run tests locally: `pytest tests/`
3. Build and test with Docker: `docker-compose up --build`
4. Test endpoints through the API Gateway
5. Test authentication flows
6. Check logs and monitoring

### Service Endpoints

**Through API Gateway (JWT required):**
- **Customer Service**: 
  - `GET /customers` - List all customers
  - `GET /customers/{id}` - Get customer by ID
  - `GET /customers/health` - Health check
  
- **Product Service**: 
  - `GET /products` - List all products
  - `GET /products/{id}` - Get product by ID
  - `GET /products/category/{category}` - Get products by category
  - `GET /products/health` - Health check

**Authentication:**
- **Token Endpoint**: `POST http://localhost:8180/realms/api-gateway-poc/protocol/openid-connect/token`
- **Admin Console**: `http://localhost:8180` (admin/admin)

### Gateway Routing
- `/customers/*` routes to Customer Service
- `/products/*` routes to Product Service
- All routes require JWT token validation
- JWT validated against Keycloak JWKS endpoint

### Security Configuration

**Keycloak Clients:**
1. **api-gateway** - Confidential client with secret (main gateway)
2. **customer-service** - Bearer-only client with secret
3. **product-service** - Bearer-only client with secret
4. **test-client** - Public client (development only, disable in production)

**Client Secrets (Development Only):**
- `api-gateway`: `gateway-secret-change-in-production`
- `customer-service`: `customer-service-secret-change-in-production`
- `product-service`: `product-service-secret-change-in-production`

**Production Requirements:**
- Change ALL client secrets
- Disable test-client
- Update redirect URIs to production domains
- Enable SSL/TLS
- Use PostgreSQL database
- Implement secrets management

See `docs/security/security-guide.md` for complete security documentation.

### Future Enhancements (Roadmap)
1. ? **Phase 1**: API Gateway & Microservices - Complete
2. ? **Phase 2**: Keycloak Integration - Complete
3. **Phase 3**: Database Integration - Add PostgreSQL for data persistence
4. **Phase 4**: CRUD Operations - Implement POST, PUT, DELETE endpoints
5. **Phase 5**: Observability - Jaeger tracing and Prometheus metrics
6. **Phase 6**: Advanced Features - Rate limiting, caching with Redis
7. **Phase 7**: CI/CD Pipeline - Automated testing and deployment
8. **Phase 8**: Kubernetes - K8s deployment manifests

### Common Development Tasks
- **Adding new service**: Create in `services/` with Dockerfile, requirements.txt, main.py
- **Adding new endpoint**: Update FastAPI app and corresponding Pydantic models
- **Gateway routing**: Update `services/gateway/envoy.yaml` configuration
- **Database changes**: Update models and add migration scripts (Phase 3)
- **Testing**: Add tests in `tests/` directory with appropriate fixtures
- **Documentation**: Update relevant docs in `docs/` directory

### Documentation Guidelines
- Keep documentation in appropriate `docs/` subdirectories
- Update `docs/README.md` index when adding new docs
- Use clear headings and code examples
- Keep security documentation up-to-date
- Update project status in `reports/project-status.md`

### Troubleshooting
- Check service logs: `docker-compose logs [service-name]`
- Verify Envoy configuration: `http://localhost:9901`
- Rebuild containers: `docker-compose down && docker-compose up --build`
- Test authentication: See `docs/security/quick-reference.md`
- Common commands: See `docs/development/quick-reference.md`

### Security Considerations
- Never commit secrets or credentials
- Use environment variables for configuration
- Implement proper CORS policies
- Validate all input data with Pydantic
- Use HTTPS in production environments
- Implement rate limiting and request size limits
- Rotate secrets regularly
- Monitor for suspicious activity

## Code Assistance Guidelines
When helping with this project:
1. Follow the established patterns and structure
2. Ensure Docker compatibility for all changes
3. Include appropriate tests for new functionality
4. Update documentation in appropriate `docs/` subdirectories
5. Consider the future roadmap when making architectural decisions
6. Always include proper error handling and logging
7. Maintain consistency across microservices
8. When making edits, update existing files rather than creating duplicates
9. Reference documentation using new paths (e.g., `docs/security/security-guide.md`)

## File Organization
- **Root**: Essential files only (README, docker-compose, .env.example, QUICK_START.md)
- **docs/**: All documentation organized by topic
- **reports/**: Project status and verification reports
- **services/**: Service code and configurations
- **scripts/**: Utility scripts with README
- **tests/**: Test files

## Markdown File Generation Policy
- Do **not** use emojis or special symbols in any generated `.md` files
- Use plain text and standard Markdown formatting for clarity and compatibility
- Place new documentation in appropriate `docs/` subdirectories
- Update `docs/README.md` index when adding new documentation